use nanomsg::{Socket, Protocol, Endpoint};
use std::{thread, time};
use std::io::{Read, Write};
use serde::{Deserialize, Serialize};
use serde_big_array::BigArray;
use chain::Transaction;
use serialization::deserialize;
use std::net::Ipv4Addr;
use bincode::Options;
use rustc_hex::{FromHex, ToHex};
use serde_json::json;


const SERVER_DEVICE_URL: &'static str = "tcp://195.201.20.230:13344";

/*
const CLIENT_DEVICE_URL: &'static str = "tcp://95.217.87.135:13344";
const MY_DEVICE_IN: &'static str = "tcp://195.201.20.230:27773";
const MY_DEVICE_OUT: &'static str = "tcp://195.201.137.5:27773";
*/

#[derive(Clone, Debug, Serialize, Deserialize, PartialEq)]
#[repr(C)]
struct IguanaPacketHeader {
    sigr: [u8; 32],
    sigs: [u8; 32],
    bits256: [u8; 32],
    nonce: u32,
    packetlen: u32
}


#[derive(Clone, Debug, Serialize, Deserialize, PartialEq)]
#[repr(C)]
struct DpowNanoUtxo {
    srcutxo: [u8; 32],
    destutxo: [u8; 32],
    bestmask: [u8;8],
    recvmask: [u8;8],
    pendingcrc1: u32,
    pendingcrc2: u32,
    paxwdcrc: u32,
    srcvout: u16,
    destvout: u16,
    #[serde(with = "BigArray")]
    sig1: [u8; 128],
    #[serde(with = "BigArray")]
    sig2: [u8; 128],
    siglens: [u8; 2],
    pad: u8,
    bestk: u8
}


#[derive(Clone, Debug, Serialize, Deserialize, PartialEq)]
#[repr(C)]
struct DpowNanoMsgHdr {
    srchash: [u8; 32],
    desthash: [u8; 32],
    ratify: DpowNanoUtxo,
    notarize: DpowNanoUtxo,
    channel: u32,
    height: u32,
    size: u32,
    datalen: u32,
    crc32: u32,
    myipbits: [u8;4],
    numipbits: u32,
    #[serde(with = "BigArray")]
    ipbits: [u32;512],
    symbol: [u8;16],
    senderind: u8,
    senderind2: u8,
    version1: u8,
    //extra: Vec<u8>
}



//https://stackoverflow.com/questions/68583968/how-to-deserialize-a-c-struct-into-a-rust-struct
fn main() {
    let mut ips = json!({});
    let binconf = bincode::DefaultOptions::new().with_fixint_encoding();//.allow_trailing_bytes();

    let mut in_socket = Socket::new(Protocol::Bus).unwrap();
    let mut in_endpoint = in_socket.bind(SERVER_DEVICE_URL).unwrap();

    let mut buffer = vec!();
    'outer: loop {
        match in_socket.read_to_end(&mut buffer) {
            Ok(_mysize) => {
                loop {
                    if buffer.len() == 0  { 
                        break; };
                    let header : IguanaPacketHeader = binconf.deserialize(&buffer[..104]).unwrap();
                    buffer = buffer[104..].to_vec();

                    let cursor = std::mem::size_of::<DpowNanoMsgHdr>() - 1;
                    let dpow_msg: DpowNanoMsgHdr = binconf.deserialize(&buffer[..cursor]).unwrap();
                    ips[format!("{}", dpow_msg.senderind)] = format!("{}", Ipv4Addr::from(u32::from_be_bytes(dpow_msg.myipbits))).into();
                    println!("{}",ips);

                    let txidtx = match header.packetlen {
                        cursor=> {
                            None
                        },
                        _=> {
                            let txid : [u8;32] = binconf.deserialize( &buffer[cursor..cursor+32]).unwrap();
                            // will fail for non-standard UTXO coins - need serialization exceptions for Â 
                            let tx : Transaction = deserialize(&buffer[cursor+32..(header.packetlen as usize)] as &[u8]).unwrap();
                            Some( TxidTx { txid: txid, tx } )
                        },
                    };
                    buffer = buffer[header.packetlen as usize..].to_vec();
                }

            }
            Err(err) => {
                println!("Client failed to receive msg '{}'.", err);
                break;
            }
        }
    }
}

#[test]
fn test_extra_data() {
    use bincode::Options;
    use std::mem;
    use rustc_hex::{FromHex,ToHex};
    use serialization::deserialize;
    let binconf = bincode::DefaultOptions::new().with_fixint_encoding();//.allow_trailing_bytes();
    let packet_hex = "0e29ea071aefbdf30d5d6986008c8c3ed87f9418cf5bec670e6c8345aa5728a47df018b54f35f119795fad914321de1999e669ff9982d1d2fbf5f7854d13db7f0035e09b447ab49d6f99576255d7046f0a3f1ad61dfc82b8bed4f0912860866d170200009c110000b3c168ed4acd96594288cee3114c77de51b6afe1ab6a866887a13a96ee80f33c00000000975abe6a2f64fe202b3988f457eeb20a4b085d597a2cc89195092cbc00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000007d923951f77142980ed6110bd0798cc70fbf4b891c4cc066229cf462d54d57a2fbf72c0e0aaddbb206fe717dbb4b962d90a4b585bc4d435d49bbb4f70d63147d6c0201010004041e7eee971786dc3f9e00000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003a8b87969b56b60a009c11000065060000cb645ccc68eedd3d4c000000bc22bb005bc1b502b29f0203b29f02058b2dfb06b29f0207b29f0208334fe4082e11630c50d1f211334f6316c6f4c81633a1c417b23f431d33a1c41dc6f4c81dbcf6e01d33a1c4214df44b278b637932b1369332b1369c349538113936276b3a8b63793b68eedd3d8794ab4a3351384ca237055352cae65452cae6558b63d064362785698ac9cf734d4ac574550ac275bcf6e0754d4ac5769e45127a36271c7b0feb52845fd95787879436896732218a34812c8a4d4b798b5c35418d8b63d08dc77f3c8e33a1838f36251e97bc8f8c9a87b5dfa45fd991a65fa35aa95fa35aab5fa35aad33a1c4b0023899b642f8ccbab00908bbbc864abcb996bfbf67d8dfc18b63efc9a23758e34e2e17e48b63bde4b9c07ceb8b6390f052cae6f8a772c5fa33a1cdfa52cae6fa52cae6fb52cae6fc00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000534655534400000000000000000000003f821766492443d13439116c9f5b979633c6f3828b59e99e896d63278167562eecdd8b0400008085202f890d8e18650989c179eade65886b5a31825f9f16ad86782cad0c8e29b81f36e1ef8d080000004847304402203c6510685dd20aaff6dad73b183c8c5ea17ffb45e616192c44010cb11264093e02205887a5d31701745c1e56b5c8f454f2c44528c3bf3a1d3c140c7c77caf5b0e58601ffffffffec8afd071dec091eba337d1bc6342a1fa3a0682df28bf62c53c58053efeb5de80300000049483045022100931f267031c20d8e6a9429ce188669ffc2277aa2ad7e5e93193c029163434a050220709fc79b03a8699604d63b64286107e3f66d04ce724690d19845ccd6570c597501ffffffffcdd03e67f187bed57b483b338776c19f496b7443e92de74b65d4a3f5a7b6f4d70b0000004847304402200bd89d1e0324c25706ab03f97feeecba6b3399ae639e341b41c95c87586fa38b02201059e853dbcb050af3502ed75b60ed14898ec3bca1cc4d5369cf1d4d4a7da82601ffffffff0e314a18230ddcce9412cde387634c184f6bbcaf54361804dfcb04b331aa84d90100000049483045022100e55fe94c82917ab8111b3c38a0dfdd5c849ec58d03c8e940605031908b8d992002201f26cadd15beea6866fb5e9ee19ddbc1f7d381a8a01437ec237fb0bf5763549b01ffffffff166b4331c7a8e2a987b86ce40cfd61d809e87a1a4eed145b27609ab5d462203f0800000049483045022100ce91b2bbefc63cdac0b6fc1c513a8836d38e196e0d2eb905af9385a813832fe50220538bb27df326a07b63bd07102dc9de73df1d5ceeeb0b517ddcbb8222487e30fc01ffffffff1fcd15c7f58c25933aa6636c37d1c9828a6f70ea4e826538894f39d1003eb01d09000000494830450221009cf59562d5b87883fa06b955b808339f5bc9757ef8431582b63984e659e1bb2302206b36fd6927322a879ed0d026c98afe204090e2f6a3c01cabbca4ebfdf6724db001ffffffffdf9a1062be5a4c46faaefe1fef5a44fd1a54db7ee6193c92b1fec24787291cd9090000004847304402202df5f1ee62418023cfd940e6c178512b5916d85abe2adf6eb4353fdf84d1032e022071d89485fc0baa26c5aadaf1631352c01ef6244e47e95a819dfd0dbc5b6c02c801ffffffff93d3377bd1dbc685d16c3924f503027da3b29a17896b04f7124379138c43abfb1400000049483045022100d971090696d348b387f3b3780930fd95dc6c7dd4d401938dedeaec17bde9861d022009f5a41ba4c2cfe84b4c1de7f18bc6a67b66e6d54c20b41db3e7c29b0121db6801ffffffff1b94ee3056c5509044920f7e9bc4044dc6ffafb5cf6a8a90fc17b49fd6ed27ae0600000049483045022100e9d5ebb77aa562d203b4bee1893828c29156242a4b7b6ebbdb1041440e0f62fc02201c349c16e16cfc4765b6cee98eca164b989f0db5b655c91fa0ce6aca1b24741601ffffffff351227440693a7a9517fc723034f0730c32746f3c0a4f41912faf79eb46233cf0200000049483045022100e85a79c6d5fa7c1bb1c39273432a52032c5a0ad86406acddbfd55a745c5e817f0220388920802d97ab12259a75093601e57378eff7b21b8c0f5d57a6abdc69df798e01fffffffffc8f798d710dad056eee6430de71126eba8c1cf9f45d0acd3c7a0b49e5654ac00500000049483045022100becde9f60fa86e009c0a0d5b0b8057a35ef044fb48be3ed841d7f40b693c0e92022023aff30c56058c5dd6beff8e5f2427ad3aca60805cf6bb5a47e241e66bd967b501ffffffff6c5a77df718e461b2c59f954a081f769ee48f2366998b830af7e07ebaa2d264b0100000049483045022100e3b9da2554e0f0697cb2dfb919cfbfccbfb6f3c10e160be29108485bb3c2fc1c02207a80d6fb47ae2a143899c439bff4e59ace4858720f46c1a109fd7d62b191778001ffffffff8e3a6cf08e172a80ae61aa1cca201fc8b318a9589f494d9411dbec9fa3d529700a00000049483045022100fe27dc5af79c97d5a685b9f3420b1b2edbf322e38585f3bd4944f0fe333892a502207da298f5e682ba8afbef3c44463a11edfe0ef3a2f45ff7d1e058c3ed8e12094001ffffffff02f0810100000000002321020e46e79a2a8d12b9b5d12c7a91adb4e454edfae43c0a0cb805427d2ac7613fd9ac00000000000000002c6a2abc2c099591c82c7a595d084b0ab2ee57f488392b20fe642f6abe5a970000000056b60a0053465553440000000000000000000000000000000000000000".to_string();
    let mut buffer = packet_hex.from_hex::<Vec<u8>>().unwrap();

    let header : IguanaPacketHeader = binconf.deserialize(&buffer[..104]).unwrap();
    buffer = buffer[104..].to_vec();

    let cursor = mem::size_of::<DpowNanoMsgHdr>() - 1;
    let dpow_msg: DpowNanoMsgHdr = binconf.deserialize(&buffer[..cursor]).unwrap();

    let txidtx = match header.packetlen as usize {
        cursor => {
            let txid : [u8;32] = binconf.deserialize( &buffer[cursor..cursor+32]).unwrap();
            let tx : Transaction = deserialize(&buffer[cursor+32..(header.packetlen as usize)] as &[u8]).unwrap();
            Some( TxidTx { txid: txid, tx } )
        },
        _=> None
    };
//        println!("payload {}", &buffer[cursor..(header.packetlen as usize)].to_hex::<String>());

        
    
    buffer = buffer[header.packetlen as usize..].to_vec();

    println!("remaining buf {:?}", buffer);
}

#[test]
fn test_real() {
    use bincode::Options;
    use rustc_hex::{FromHex,ToHex};
    use serialization::deserialize;
    let buf_hex = "35536c5065b8bdbd66f9435b8b396a7c68f36216b69d0b2a764a116b3320f17c0c899081fc26d6659060963e1458da9f204de80fa0491520da059b14ca6da93c00b5efe19b1ecbacb1203fa414e5078195a5d31ec1992eb0e0e27ed8439ff60f76000000370b0000b3c168ed4acd96594288cee3114c77de51b6afe1ab6a866887a13a96ee80f33c4f2f8c06f7598827b16e4ce3ca5bc7ec082dd87e6fcd510b1fc993658605d8c600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005d25cedcaa5ba4f7e46485abaeb1450230f5c392cd2509828f89ff1187d654e338670bee52ae8639a1aae08fa326a379ad994fb31af03f1b617054dbd9740294000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ff00000000737c0600370b0000000000000000000068eedd3d49000000bc22bb005bc1b502b29f0203b29f02058b2dfb06b29f0207b29f0208334fe4082e11630c50d1f211334f6316c6f4c81633a1c417b23f431d33a1c41dc6f4c81dbcf6e01d33a1c4214df44b278b637932b1369332b1369c34953811398b63793b68eedd3d8794ab4a3351384ca237055352cae65452cae6558b63d064362785698ac9cf734d4ac574550ac275bcf6e0754d4ac5769e45127a36271c7b0feb52845fd95787879436896732218a34812c8a4d4b798b5c35418d8b63d08dc77f3c8e33a1838f36251e97bc8f8c9a87b5dfa45fd991a65fa35aa95fa35aab5fa35aad33a1c4b0023899b642f8ccbab00908bbbc864abc67d8dfc18b63efc9a23758e34e2e17e4b9c07ceb8b6390f052cae6f8a772c5fa33a1cdfa52cae6fa52cae6fb52cae6fc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004d494c000000000000000000000000003f8217".to_string();
    let mut buffer = buf_hex.from_hex::<Vec<u8>>().unwrap();
    let binconf = bincode::DefaultOptions::new().with_fixint_encoding();//.allow_trailing_bytes();


    let header : IguanaPacketHeader = binconf.deserialize(&buffer[..104]).unwrap();
    buffer = buffer[104..].to_vec();

    let cursor = std::mem::size_of::<DpowNanoMsgHdr>() - 1;
    let dpow_msg: DpowNanoMsgHdr = binconf.deserialize(&buffer[..cursor]).unwrap();

    let txidtx = match header.packetlen {
        cursor=> {
            None
        },
        _=> {
            let txid : [u8;32] = binconf.deserialize( &buffer[cursor..cursor+32]).unwrap();
            let tx : Transaction = deserialize(&buffer[cursor+32..(header.packetlen as usize)] as &[u8]).unwrap();
            Some( TxidTx { txid: txid, tx } )
        },
    };
    buffer = buffer[header.packetlen as usize..].to_vec();
    //buffer = buffer[104..].to_vec();
}

#[test]
fn test_txidtx_deser() {
    use bincode::Options;
    use rustc_hex::{FromHex,ToHex};
    use serialization::deserialize;

    let binconf = bincode::DefaultOptions::new().with_fixint_encoding();//.allow_trailing_bytes();
    let buf_hex = "66492443d13439116c9f5b979633c6f3828b59e99e896d63278167562eecdd8b0400008085202f890d8e18650989c179eade65886b5a31825f9f16ad86782cad0c8e29b81f36e1ef8d080000004847304402203c6510685dd20aaff6dad73b183c8c5ea17ffb45e616192c44010cb11264093e02205887a5d31701745c1e56b5c8f454f2c44528c3bf3a1d3c140c7c77caf5b0e58601ffffffffec8afd071dec091eba337d1bc6342a1fa3a0682df28bf62c53c58053efeb5de80300000049483045022100931f267031c20d8e6a9429ce188669ffc2277aa2ad7e5e93193c029163434a050220709fc79b03a8699604d63b64286107e3f66d04ce724690d19845ccd6570c597501ffffffffcdd03e67f187bed57b483b338776c19f496b7443e92de74b65d4a3f5a7b6f4d70b0000004847304402200bd89d1e0324c25706ab03f97feeecba6b3399ae639e341b41c95c87586fa38b02201059e853dbcb050af3502ed75b60ed14898ec3bca1cc4d5369cf1d4d4a7da82601ffffffff0e314a18230ddcce9412cde387634c184f6bbcaf54361804dfcb04b331aa84d90100000049483045022100e55fe94c82917ab8111b3c38a0dfdd5c849ec58d03c8e940605031908b8d992002201f26cadd15beea6866fb5e9ee19ddbc1f7d381a8a01437ec237fb0bf5763549b01ffffffff166b4331c7a8e2a987b86ce40cfd61d809e87a1a4eed145b27609ab5d462203f0800000049483045022100ce91b2bbefc63cdac0b6fc1c513a8836d38e196e0d2eb905af9385a813832fe50220538bb27df326a07b63bd07102dc9de73df1d5ceeeb0b517ddcbb8222487e30fc01ffffffff1fcd15c7f58c25933aa6636c37d1c9828a6f70ea4e826538894f39d1003eb01d09000000494830450221009cf59562d5b87883fa06b955b808339f5bc9757ef8431582b63984e659e1bb2302206b36fd6927322a879ed0d026c98afe204090e2f6a3c01cabbca4ebfdf6724db001ffffffffdf9a1062be5a4c46faaefe1fef5a44fd1a54db7ee6193c92b1fec24787291cd9090000004847304402202df5f1ee62418023cfd940e6c178512b5916d85abe2adf6eb4353fdf84d1032e022071d89485fc0baa26c5aadaf1631352c01ef6244e47e95a819dfd0dbc5b6c02c801ffffffff93d3377bd1dbc685d16c3924f503027da3b29a17896b04f7124379138c43abfb1400000049483045022100d971090696d348b387f3b3780930fd95dc6c7dd4d401938dedeaec17bde9861d022009f5a41ba4c2cfe84b4c1de7f18bc6a67b66e6d54c20b41db3e7c29b0121db6801ffffffff1b94ee3056c5509044920f7e9bc4044dc6ffafb5cf6a8a90fc17b49fd6ed27ae0600000049483045022100e9d5ebb77aa562d203b4bee1893828c29156242a4b7b6ebbdb1041440e0f62fc02201c349c16e16cfc4765b6cee98eca164b989f0db5b655c91fa0ce6aca1b24741601ffffffff351227440693a7a9517fc723034f0730c32746f3c0a4f41912faf79eb46233cf0200000049483045022100e85a79c6d5fa7c1bb1c39273432a52032c5a0ad86406acddbfd55a745c5e817f0220388920802d97ab12259a75093601e57378eff7b21b8c0f5d57a6abdc69df798e01fffffffffc8f798d710dad056eee6430de71126eba8c1cf9f45d0acd3c7a0b49e5654ac00500000049483045022100becde9f60fa86e009c0a0d5b0b8057a35ef044fb48be3ed841d7f40b693c0e92022023aff30c56058c5dd6beff8e5f2427ad3aca60805cf6bb5a47e241e66bd967b501ffffffff6c5a77df718e461b2c59f954a081f769ee48f2366998b830af7e07ebaa2d264b0100000049483045022100e3b9da2554e0f0697cb2dfb919cfbfccbfb6f3c10e160be29108485bb3c2fc1c02207a80d6fb47ae2a143899c439bff4e59ace4858720f46c1a109fd7d62b191778001ffffffff8e3a6cf08e172a80ae61aa1cca201fc8b318a9589f494d9411dbec9fa3d529700a00000049483045022100fe27dc5af79c97d5a685b9f3420b1b2edbf322e38585f3bd4944f0fe333892a502207da298f5e682ba8afbef3c44463a11edfe0ef3a2f45ff7d1e058c3ed8e12094001ffffffff02f0810100000000002321020e46e79a2a8d12b9b5d12c7a91adb4e454edfae43c0a0cb805427d2ac7613fd9ac00000000000000002c6a2abc2c099591c82c7a595d084b0ab2ee57f488392b20fe642f6abe5a970000000056b60a0053465553440000000000000000000000000000000000000000".to_string();

    let buffer = buf_hex.from_hex::<Vec<u8>>().unwrap();

    let tx : Transaction = deserialize(&buffer[32..] as &[u8]).unwrap();

    //let s : Transaction = serialization::serialize(&buffer[32..])

    println!("s {:?}", tx);
    //let txidtx : TxidTx = binconf.deserialize(&buffer).unwrap();
}

#[derive(Clone, Debug, Serialize, Deserialize, PartialEq)]
struct TxidTx {
    txid: [u8;32],
    tx: Transaction,
}

#[test]
fn test_bincode() {
    use bincode::Options;
    use rustc_hex::{FromHex,ToHex};
    let binconf = bincode::DefaultOptions::new().with_fixint_encoding();//.allow_trailing_bytes();
    let exp_hex = "1db4bb74c4a380deb176154ca1bd16ca3412a14bee8518d771d9b26d5731257423b80b567d3df2ebda084dee07dee33f9e8f59f8ddae8ab11c154adc26d9fc2b00166718fbb7657ff2a43b7fa60477745d94c12e29273b77a0575397adb2afc91d010000370b0000b3c168ed4acd96594288cee3114c77de51b6afe1ab6a866887a13a96ee80f33c00000015003a1d53e5cc0a54f30c644108a6768e3cad134f4014da68ab8caece0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000465920e27e5092f4d9501a5179fde66c002dff5bc48f680442995353e0e25750f6f9378ab576154f0e64775d058041382e715ed7e5f5bebaf0696c74c5287a170000000000000000400000008000008000000000000000004894338d0200020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ff0000000022480900370b0000000000000000000068eedd3d4e000000bc22bb005bc1b502b29f0203b29f02058b2dfb06b29f0207b29f0208334fe4082e11630c50d1f211334f6316c6f4c81633a1c417b23f431d33a1c41dc6f4c81dbcf6e01d9030262133a1c4214df44b278b637932b1369332b1369c348b6395369538113936276b3a8b63793b68eedd3d8794ab4a3351384ca237055352cae65452cae6558b63d064362785698ac9cf734d4ac574550ac275bcf6e0754d4ac5769e45127a36271c7b0feb52845fd95787879436896732218a34812c8a4d4b798b5c35418d8b63d08dc77f3c8e33a1838f36251e97bc8f8c9a87b5dfa45fd991a65fa35aa95fa35aab5fa35aad33a1c4b0023899b642f8ccbab00908bbbc864abcb996bfbf67d8dfc18b63efc9a23758e34e2e17e48b63bde4b9c07ceb8b6390f052cae6f8a772c5fa33a1cdfa52cae6fa52cae6fb52cae6fc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000544f4b454c00000000000000000000003f8217".to_string();
    let packet = exp_hex.from_hex::<Vec<u8>>().unwrap();
    //let header : &iguana_packet_header = unsafe{ &*exp[..104].as_ptr().cast() };
    //println!("packet? {:?}", header);
    //println!("1 {}", &exp[..104].to_hex::<String>());
    let header_vec = &packet[..104];
    let header_safe: IguanaPacketHeader = binconf.deserialize(header_vec).unwrap();
    println!("header {:?}", header_safe);

    let pack_vec = &packet[104..(header_safe.packetlen + 104) as usize];

    let packet_safe: DpowNanoMsgHdr = binconf.deserialize(pack_vec).unwrap();
    println!("pack {:?}", packet_safe);
    //let unser = binconf.serialize(&header).unwrap();
    //println!("2 {}", unser.to_hex::<String>());

}
